name: opencode

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  opencode:
    if: |
      contains(github.event.comment.body, '/oc') ||
      contains(github.event.comment.body, '/opencode')
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read # 通常需要读取权限
      pull-requests: write # 如果需要评论 PR
    steps:
       - name: Checkout repository
         uses: actions/checkout@v6
         with:
           fetch-depth: 1
           persist-credentials: false

       # 关键步骤：在运行 OpenCode 之前，创建或修改配置文件
       - name: Configure OpenCode for custom model
         run: |
           # 创建 OpenCode 的配置目录
           mkdir -p ~/.config/opencode
           
           # 写入配置文件，指向你的自部署模型
           # 假设你的模型服务运行在 http://118.252.19.92:44331/v1 且兼容 OpenAI 接口
           cat > ~/.config/opencode/opencode.json << 'EOF'
           {
             "$schema": "https://opencode.ai/config.json",
             "model": "custom-provider/Qwen3.5-397B-A17B-UD-Q4_K_XL-00001-of-00006.gguf", # 格式：provider名/模型ID
             "provider": {
               "custom-provider": { # 自定义 provider 名称
                 "npm": "@ai-sdk/openai-compatible", # 使用 OpenAI 兼容 SDK
                 "name": "My Custom Model",
                 "options": {
                   "baseURL": "http://118.252.19.92:44331/v1", # 你的模型 API 地址，必须以 /v1 结尾 [citation:5]
                   "apiKey": "{env:CUSTOM_MODEL_API_KEY}" # 从环境变量读取 API Key
                 },
                 "models": {
                   "Qwen3.5-397B-A17B-UD-Q4_K_XL-00001-of-00006.gguf": { # 这里的键对应上面的 "Qwen3.5-397B-A17B-UD-Q4_K_XL-00001-of-00006.gguf"
                     "id": "actual-model-id-used-in-request", # 实际请求时用的模型 ID
                     "name": "Display Name"
                   }
                 }
               }
             }
           }
           EOF
           echo "✅ OpenCode 配置文件已写入"

       # 现在运行 OpenCode Action，它会读取我们刚才创建的配置
       - name: Run OpenCode
         uses: anomalyco/opencode/github@latest
         env:
           # 不再需要 ANTHROPIC_API_KEY
           # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
           # 传递你的自定义模型 API Key
           CUSTOM_MODEL_API_KEY: ${{ secrets.CUSTOM_MODEL_API_KEY }}
         with:
           # model 参数可以留空，或者与配置文件中的保持一致
           model: "custom-provider/Qwen3.5-397B-A17B-UD-Q4_K_XL-00001-of-00006.gguf"
           share: true
           github_token: ${{ secrets.GITHUB_TOKEN }}